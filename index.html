
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>جدول ومستوى الماء</title>
<style>
  :root {
      --primary-color: #00796B;
      --secondary-color: #8BC34A;
      --accent-color: #FFC107;
      --background-light: #F9FBE7;
      --background-medium: #DCEDC8;
      --text-dark: #212121;
      --text-light: #fff;
      --card-bg: #fff;
      --past-color: #B71C1C;
  }
  
  body {
      font-family: Arial, sans-serif; /* تم التغيير لضمان التوافق مع Google Sites */
      background: var(--background-light);
      margin: 0;
      padding: 10px;
      color: var(--text-dark);
      line-height: 1.6;
  }
  
  .section-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      background-color: var(--card-bg);
  }
  
  h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
      font-weight: bold;
  }
  
  h1 {
      font-size: 26px;
      padding-bottom: 5px;
      border-bottom: 2px solid var(--secondary-color);
      display: inline-block;
  }

  .tank-container {
      position: relative;
      width: 150px; /* تم تصغير الحجم ليتناسب مع الجوال */
      margin: 20px auto;
  }
  .tank-image {
      width: 100%;
      display: block;
      border-radius: 10px;
  }
  .water-level {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 0%;
      background-color: rgba(0,123,255,0.5);
      border-radius: 0 0 10px 10px;
      transition: height 0.5s ease;
  }
  .data-display {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
  }
  #updateTime {
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
  }

  .password-prompt {
      text-align: center;
      padding: 20px;
  }
  input[type="password"] {
      padding: 8px;
      font-size: 14px;
      width: 180px;
      margin-right: 5px;
  }
  button {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      background-color: var(--primary-color);
      color: var(--text-light);
      border: none;
      border-radius: 5px;
  }

  /* جدول السقاية */
  .person-box {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
      background-color: #E8F5E9;
      font-size: 18px;
      font-weight: bold;
  }
  .person-name {
      color: var(--primary-color);
  }
  .countdown-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
  }
  .countdown-circle {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(var(--primary-color) 0%, transparent 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      box-shadow: 0 4px 10px rgba(0, 121, 107, 0.2);
  }
  .countdown-circle::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: #fff;
      border-radius: 50%;
  }
  #timer-text {
      position: relative;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-color);
      z-index: 1;
  }
  .countdown-label {
      font-size: 14px;
      color: var(--text-dark);
      margin-top: -8px;
      font-weight: bold;
  }
  table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 13px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  th, td {
      padding: 10px;
      border: 1px solid #E0E0E0;
      text-align: center;
  }
  th {
      background: var(--primary-color);
      color: var(--text-light);
      font-weight: bold;
  }
  tr:nth-child(even) {
      background-color: #F5F5F5;
  }
  tr.selected {
      background-color: var(--accent-color);
      font-weight: bold;
      color: #5D4037;
  }
  tr.past {
      color: var(--past-color);
      text-decoration: line-through;
  }
  tr.emergency {
      background-color: #FFECB3;
      font-weight: bold;
      color: #FF8F00;
  }
  
  .detail-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 5px;
  }
  .detail-btn:hover {
      background: #004D40;
  }
  
  #detailsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
  }
  #detailsModalContent {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 90vw;
      width: 400px;
      text-align: right;
      position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
  }
  #closeModal {
      position: absolute;
      top: 10px;
      left: 15px;
      cursor: pointer;
      font-size: 24px;
      font-weight: bold;
      color: #555;
  }
  .modal-row {
      display: flex;
      flex-direction: column; /* التغيير الأساسي للتجاوب مع الجوال */
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
  }
  .modal-label {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 15px;
      margin-bottom: 5px;
  }
  .modal-value {
      flex: 1;
      text-align: right;
      font-size: 15px;
      padding: 5px 10px;
      border-radius: 5px;
      background: #f9f9f9;
  }
</style>
</head>
<body>

<div class="section-container">
  <h1>مستوى الماء في الخزان</h1>
  <div class="password-prompt" id="passwordPrompt">
    <p>أدخل كلمة السر لعرض مستوى الماء:</p>
    <input type="password" id="passwordInput" placeholder="كلمة السر">
    <button onclick="checkPassword()">دخول</button>
  </div>
  
  <div class="tank-container" id="tankContainer">
    <img src="https://i.postimg.cc/d0jvThnd/file-0000000089fc6246b605b17eb2fbc278-2.png" alt="خزان ماء" class="tank-image">
    <div class="water-level" id="waterLevel"></div>
  </div>
  
  <div class="data-display" id="percentDisplay"></div>
  <div class="data-display" id="litersDisplay"></div>
  <div id="updateTime"></div>
</div>

<div class="section-container">
      
    <div class="person-box">
        سَقْوُهُ اليوم: <span id="currentPerson" class="person-name">جارٍ التحديد...</span>
    </div>
    <div class="countdown-container">
        <div class="countdown-circle">
            <span id="timer-text">--:--:--</span>
        </div>
        <div class="countdown-label">الوقت المتبقي </div>
    </div>
</div>

<div class="section-container">
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>اليوم</th>
          <th>التاريخ</th>
          <th>الاسم</th>
          <th>ملاحظة</th>
        </tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>
</div>

<div class="section-container">
    <h2>المؤهلون لأيام الطوارئ</h2>
    <p>الأشخاص المذكورون في الجدول أدناه فقط هم المؤهلون لاستخدام أيام الطوارئ.</p>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>مدة السقيا</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>1</td><td>يحيى جابر</td><td>1 ساعة</td></tr>
        <tr><td>2</td><td>عبدالله محمد جابر</td><td>1 ساعة</td></tr>
        <tr><td>3</td><td>خزانات الجيران في الحي</td><td>1 ساعة</td></tr>
      </tbody>
    </table>
    <div class="policy">
      <br>
      <ul>
        <li>مدة السقيا في حالة الطوارئ لا تتجاوز <strong>ساعة واحدة فقط</strong></li>
        <li>لا يتم منح أكثر من يوم طوارئ إلا بعد التأكد من الحاجة الحقيقية</li>
        <li>أي تجاوز أو تلاعب يتم استبعاده مباشرة ودون تنبيه</li>
      </ul>
    </div>
</div>

<div id="detailsModal">
    <div id="detailsModalContent">
        <span id="closeModal">&times;</span>
        <div class="modal-header">
            <h2>تفاصيل السَقْيَة</h2>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">اسم الشخص:</span>
            <span class="modal-value" id="modalPerson"></span>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">التاريخ:</span>
            <span class="modal-value" id="modalDate"></span>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">وقت بدء السَقْيَة:</span>
            <span class="modal-value" id="modalStart"></span>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">وقت انتهاء السَقْيَة:</span>
            <span class="modal-value" id="modalEnd"></span>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">حالة السَقْيَة:</span>
            <span class="modal-value" id="modalStatus"></span>
        </div>
        
        <div class="modal-row">
            <span class="modal-label">ملاحظات:</span>
            <span class="modal-value" id="modalNote"></span>
        </div>
    </div>
</div>

<script>
    // Tank logic
    const TANK_HEIGHT_M = 3.9;
    const TANK_DIAMETER_M = 3.7;
    const TANK_RADIUS_M = TANK_DIAMETER_M / 2;
    const TOTAL_TANK_VOLUME_LITERS = Math.PI * Math.pow(TANK_RADIUS_M, 2) * TANK_HEIGHT_M * 1000;
    const apiUrl = "https://script.google.com/macros/s/AKfycbzVB7uPTsNbotACV0aWTb7Y37wsI47BwCVbz_l4kitBgOBv9r_wTQJQGGWfjyGMU4ky/exec";
    const encryptedPassword = "aHBydQ==";

    function checkPassword() {
      const entered = document.getElementById("passwordInput").value;
      const encodedEntered = btoa(entered);
      if (encodedEntered === encryptedPassword) {
        document.getElementById("passwordPrompt").style.display = "none";
        document.getElementById("tankContainer").style.display = "block";
        document.getElementById("percentDisplay").style.display = "block";
        document.getElementById("litersDisplay").style.display = "block";
        document.getElementById("updateTime").style.display = "block";
        fetchWaterData();
        setInterval(fetchWaterData, 60000);
      } else {
        alert("كلمة السر خاطئة، حاول مرة أخرى.");
      }
    }

    function fetchWaterData() {
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          const percent = parseFloat(data.percent) || 0;
          const liters = (percent / 100) * TOTAL_TANK_VOLUME_LITERS;
          document.getElementById("waterLevel").style.height = percent + "%";
          document.getElementById("percentDisplay").textContent = `النسبة الحالية: ${percent.toFixed(2)}%`;
          document.getElementById("litersDisplay").textContent = `الكمية الحالية: ${liters.toFixed(2)} لتر`;
          document.getElementById("updateTime").textContent = `آخر تحديث: ${data.lastUpdated || "غير معروف"}`;
        })
        .catch(err => {
          console.error("Error fetching data:", err);
          document.getElementById("percentDisplay").textContent = "تعذر تحميل البيانات";
          document.getElementById("litersDisplay").textContent = "";
          document.getElementById("updateTime").textContent = "";
        });
    }

    // Schedule logic
    const people = [
        "مفرح عمضان", "محمد عمضان", "مفرح جابر", "يحيى بن جابر", "علي يحيى",
        "أحمد مفرح", "يحيى مفرح", "جابر يحيى", "حسين يحيى", "محمد مفرح",
        "علي جابر", "محمد يحيى", "علي أحمد", "محمد أحمد", "ماطر أحمد علي",
        "قاسم جابر", "جابر حسين", "مفرح أحمد", "يحيى علي", "جابر أحمد",
        "أحمد بن يحيى", "أحمد شوعان", "محمد جبار", "home",
    ];
    let emergencyDays = [5, 10, 15, 20, 25,30 ];
    let scheduleTable = [];
    let currentSchedule = null;
    let nextSchedule = null;

    function getDayName(date) { 
        const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت']; 
        return days[date.getDay()]; 
    }

    function formatDateFull(date) {
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        return date.toLocaleDateString('ar-EG', options);
    }

    function formatDateTimeFull(date) {
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
        return date.toLocaleDateString('ar-EG', options);
    }

    function generateSchedule() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';
        
        const lastMonth = new Date(year, month, 0);
        const lastMonthDays = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
        
        let dayCounter = 0;
        for (let d = 1; d <= lastMonthDays; d++) {
            if (!emergencyDays.includes(d)) {
                dayCounter++;
            }
        }
        
        scheduleTable = [];
        
        for (let i = 0; i < daysInMonth; i++) {
            const date = new Date(year, month, i + 1);
            let start = new Date(year, month, i, 17, 0, 0);
            let end = new Date(year, month, i, 17, 0, 0);
            end.setDate(end.getDate() + 1);
            
            let personName = '', noteText = '', isEmergency = false;

            if (emergencyDays.includes(i + 1)) {
                personName = 'يوم طوارئ';
                noteText = '';
                isEmergency = true;
            } else {
                const personIndex = dayCounter % people.length;
                personName = people[personIndex];
                noteText = '';
                dayCounter++;
            }
            
            scheduleTable.push({ date, personName, start, end, note: noteText, isEmergency });
        }

        scheduleTable.forEach(entry => {
            const row = document.createElement('tr');
            const nowDate = new Date();
            
            if (nowDate >= entry.start && nowDate < entry.end) {
                row.classList.add('selected');
                currentSchedule = entry;
            }
            if (nowDate > entry.end) {
                row.classList.add('past');
            }
            if (entry.isEmergency) {
                row.classList.add('emergency');
            }
            
            row.innerHTML = `
                <td>${getDayName(entry.date)}</td>
                <td>${entry.date.toLocaleDateString('ar-EG', { month: 'long', day: 'numeric' })}</td>
                <td>${entry.personName}</td>
                <td>
                    ${entry.note}
                    <button class="detail-btn" onclick="showDetails('${entry.personName}', '${entry.start.toISOString()}', '${entry.end.toISOString()}', '${entry.note}', ${entry.isEmergency})">تفاصيل</button>
                </td>`;
            
            tbody.appendChild(row);
        });
        updateCurrentSchedule();
    }

    function updateCurrentSchedule() {
        const now = new Date();
        const cs = scheduleTable.find(e => now >= e.start && now < e.end);
        currentSchedule = cs || null;
        
        nextSchedule = null;
        if (scheduleTable.length > 0) {
            for (let i = 0; i < scheduleTable.length; i++) {
                if (now < scheduleTable[i].start) {
                    nextSchedule = scheduleTable[i];
                    break;
                }
            }
        }
        
        document.getElementById('currentPerson').textContent = cs ? cs.personName : "لا يوجد سَقْيَة الآن";
    }

    function showDetails(name, start, end, note, isEmergency) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        const now = new Date();
        
        document.getElementById('modalPerson').textContent = name;
        document.getElementById('modalDate').textContent = formatDateFull(startDate);
        document.getElementById('modalStart').textContent = formatDateTimeFull(startDate);
        document.getElementById('modalEnd').textContent = formatDateTimeFull(endDate);
        
        let status = '';
        if (now < startDate) {
            status = 'لم تبدأ بعد';
        } else if (now >= startDate && now < endDate) {
            status = 'يستقي الان';
        } else {
            status = 'انتهت';
        }
        
        document.getElementById('modalStatus').textContent = status;
        document.getElementById('modalNote').textContent = note;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    document.getElementById('closeModal').onclick = function() {
        document.getElementById('detailsModal').style.display = 'none';
    }

    function updateRemainingTime() {
        const now = new Date();
        updateCurrentSchedule();
        
        if (!nextSchedule) {
            document.getElementById('timer-text').textContent = "--:--:--";
            document.querySelector('.countdown-circle').style.background = `conic-gradient(var(--primary-color) 0%, transparent 0%)`;
            return;
        }
        
        const diff = nextSchedule.start - now;
        
        if (diff <= 0) {
            document.getElementById('timer-text').textContent = "00:00:00";
            document.querySelector('.countdown-circle').style.background = `conic-gradient(var(--primary-color) 100%, transparent 100%)`;
            generateSchedule();
            return;
        }
        
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor((diff / 1000 / 60) % 60);
        const seconds = Math.floor((diff / 1000) % 60);
        
        document.getElementById('timer-text').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        const totalDuration = nextSchedule.start - (new Date(nextSchedule.start.getFullYear(), nextSchedule.start.getMonth(), nextSchedule.start.getDate(), 0, 0, 0));
        const percentage = 100 - (diff / totalDuration) * 100;
        const adjustedPercentage = Math.min(Math.max(percentage, 0), 100);
        
        document.querySelector('.countdown-circle').style.background = `conic-gradient(var(--primary-color) ${adjustedPercentage}%, transparent ${adjustedPercentage}%)`;
    }

    window.onload = function() {
        // Hide elements initially
        document.getElementById("tankContainer").style.display = "none";
        document.getElementById("percentDisplay").style.display = "none";
        document.getElementById("litersDisplay").style.display = "none";
        document.getElementById("updateTime").style.display = "none";

        generateSchedule();
        updateRemainingTime();
        setInterval(updateRemainingTime, 1000);
        setInterval(generateSchedule, 60 * 60 * 1000);
    }
</script>

</body>
</html>
